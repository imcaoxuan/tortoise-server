<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>多人运动</title>
    <script src="https://code.caoxuan.top/js/jquery-3.5.1.js"></script>
    <script type="text/javascript" src="/static/js/uuid.js"></script>
    <script type="text/javascript" src="/static/js/mine.js"></script>
    <script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script th:inline="javascript">
        $(function () {
            var roomId = $.cookie('roomId');
            //我的userId
            var me = Math.uuid();
            var serverHost = "ws://" + window.location.host + "/echo";
            console.log(serverHost)
            if ("WebSocket" in window) {
                //alert("您的浏览器支持 WebSocket!");

                // 打开一个 web socket
                var ws = new WebSocket(serverHost);

                ws.onopen = function () {
                    // Web Socket 已连接上，使用 send() 方法发送数据
                    alert("已连接服务器");
                    ws.send("{\"type\":0,\"roomId\":\"" + roomId + "\"}");
                };

                ws.onmessage = function (evt) {
                    var received_msg = evt.data;
                    console.log(received_msg);
                    var message = JSON.parse(received_msg);
                    if (me !== message["from"]) {
                        var content = message["content"];
                        draw(false,content)
                    }
                };
                ws.onclose = function (ev) {
                    // 关闭 websocket
                    alert("连接已关闭" + ev.reason)
                };
            } else {
                // 浏览器不支持 WebSocket
                alert("您的浏览器不支持 WebSocket!");
                return;
            }
            $("#send").click(function () {
                const file = $("#file");
                const inputText = $("#inputText");
                let content;
                if ("" !== file.val()) {
                    const fileName = getFileName(file.val());
                    content = "<a href='" + "/files/" + fileName + "'>" + fileName + "</a>";
                    //成功后draw();Controller将会向所有人广播这条消息,me是为自己过滤这条广播
                    upload(content, me);
                } else {
                    content = inputText.val();
                    draw(true, content);
                    send(ws,content,roomId,me);
                }
                inputText.val("");

            });
        });



    </script>
    <script type="text/javascript">

    </script>
    <style>
        #box {
            width: 480px;
            height: 960px;
            margin: 0 auto;
        }

        #displayText {
            border: black solid 1px;
            width: 480px;
            height: 480px;
            resize: none;
            float: left;
            font-size: 18px;
            overflow-y: auto;
        }

        #in {
            float: left;
            width: 100%;
            position: relative;
        }

        #inputText {
            width: 100%;
            height: 50px;
            font-size: 16px;
            resize: none;
        }

        #send {
            position: absolute;
            top: 50%;
            right: 0;
        }
    </style>
</head>
<body>
<div id="box">
    <div id="displayText"></div>
    <div id="in"><textarea id="inputText"></textarea><input id="send" type="submit" value="发送"></div>
    <form id="form" enctype="multipart/form-data">
        文件：<input type="file" name="file" id="file">
    </form>
</div>
</body>

</html>